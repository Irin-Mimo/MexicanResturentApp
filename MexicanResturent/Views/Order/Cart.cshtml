
@model OrderViewModel

<h1 class="mb-4">My Cart</h1>

@if (Model.OrderItems != null && Model.OrderItems.Count > 0)
{
    <div class="row g-4">
        @foreach (var item in Model.OrderItems)
        {
            <div class="col-md-4 col-sm-6 d-flex">
                <div class="card h-100 shadow-sm card-hover w-100">
                @*     <img src="@Url.Content("~/images/" + item.ProductImageUrl)" class="card-img-top" style="height:200px; object-fit:cover;" alt="@item.ProductName" /> *@

                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">@item.ProductName</h5>
                        <p class="card-text text-success fw-bold">@item.Price.ToString("C")</p>
                        <p class="card-text">
                            Quantity:
                            <button type="button" class="btn btn-sm btn-outline-secondary qty-decrease" data-id="@item.ProductId">-</button>
                            <span id="qty-@item.ProductId" class="mx-2">@item.Quantity</span>
                            <button type="button" class="btn btn-sm btn-outline-secondary qty-increase" data-id="@item.ProductId">+</button>
                        </p>

                        <form asp-action="RemoveFromCart" method="post" class="mt-auto remove-form">
                            <input type="hidden" name="productId" value="@item.ProductId" />
                            <button type="submit" class="btn btn-danger w-100 btn-sm remove-btn">
                                <i class="bi bi-trash"></i> Remove
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        }
    </div>

    <div class="mt-4 d-flex justify-content-end align-items-center gap-3">
        <h4>Total: <span id="totalAmount" class="text-primary fw-bold">@Model.TotalAmount.ToString("C")</span></h4>
        <form asp-action="PlaceOrder" method="post">
            <button type="submit" class="btn btn-primary">Place Order</button>
        </form>
    </div>
}
else
{
    <p class="text-center fs-5">Your cart is empty.</p>
}

<!-- Toast -->
<div class="position-fixed top-0 end-0 p-3" style="z-index:1055">
    <div id="cartToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toastMessage">Cart updated!</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<style>
    .card-hover {
        transition: transform 0.3s, box-shadow 0.3s;
    }

        .card-hover:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
        }
</style>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var toastEl = document.getElementById('cartToast');
            var toastMessage = document.getElementById('toastMessage');
            var toast = new bootstrap.Toast(toastEl);

            // Remove item from cart
            document.querySelectorAll('.remove-form').forEach(function(form){
                form.addEventListener('submit', function(e){
                    e.preventDefault();
                    var productId = form.querySelector('input[name="productId"]').value;

                    fetch(form.action, {
                        method: 'POST',
                        body: new URLSearchParams(new FormData(form))
                    }).then(() => {
                        // Remove card visually
                        form.closest('.col-md-4').remove();
                        toastMessage.innerText = "Product removed from cart!";
                        toast.show();
                        updateTotal();
                    });
                });
            });

            // Quantity increase/decrease buttons
            document.querySelectorAll('.qty-increase').forEach(btn => {
                btn.addEventListener('click', function(){
                    var id = btn.getAttribute('data-id');
                    var qtyElem = document.getElementById('qty-' + id);
                    var qty = parseInt(qtyElem.innerText);
                    qtyElem.innerText = qty + 1;
                    toastMessage.innerText = "Quantity increased!";
                    toast.show();
                    // Optionally: send AJAX to server to update session
                    updateTotal();
                });
            });

            document.querySelectorAll('.qty-decrease').forEach(btn => {
                btn.addEventListener('click', function(){
                    var id = btn.getAttribute('data-id');
                    var qtyElem = document.getElementById('qty-' + id);
                    var qty = parseInt(qtyElem.innerText);
                    if(qty > 1) {
                        qtyElem.innerText = qty - 1;
                        toastMessage.innerText = "Quantity decreased!";
                        toast.show();
                        // Optionally: send AJAX to server to update session
                        updateTotal();
                    }
                });
            });

            function updateTotal(){
                // Optional: recalculate total locally
                var total = 0;
                document.querySelectorAll('[id^="qty-"]').forEach(qtyElem => {
                    var id = qtyElem.id.split('-')[1];
                    var priceElem = qtyElem.closest('.card-body').querySelector('.card-text.text-success');
                    var price = parseFloat(priceElem.innerText.replace(/[^0-9.-]+/g,""));
                    total += price * parseInt(qtyElem.innerText);
                });
                document.getElementById('totalAmount').innerText = total.toLocaleString('en-US', {style:'currency', currency:'USD'});
            }
        });
    </script>
}
